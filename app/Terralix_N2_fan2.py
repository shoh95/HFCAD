import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d
import matplotlib.cm as cm

# ------------------- 1. 실측 데이터 입력 -------------------
x_pwm100 = np.array([0.03557, 0.083, 0.14229, 0.18972, 0.2253, 0.27273, 0.32016, 0.37945, 0.40316, 0.46245, 0.50988, 0.56917, 0.62846, 0.66403, 0.72332, 0.77075, 0.81818, 0.86561, 0.9249, 0.99605, 1.01976, 1.06719, 1.12648, 1.17391, 1.24506, 1.30435, 1.35178, 1.41107, 1.4585, 1.52964, 1.57708, 1.64822, 1.69565, 1.75494, 1.80237, 1.86166, 1.92095, 1.99209, 2.01581, 2.0751, 2.14625, 2.19368, 2.26482, 2.33597, 2.39526, 2.49012, 2.58498, 2.65613, 2.72727, 2.79842, 2.86957, 2.94071, 3.02372, 3.10672, 3.17787, 3.24901, 3.32016, 3.3913, 3.45059, 3.52174, 3.58103, 3.64032, 3.68775, 3.75889, 3.80632, 3.85375, 3.88933, 3.93676, 3.99605, 4.07905, 4.11462, 4.16206, 4.19763, 4.24506, 4.28063, 4.32806, 4.36364, 4.41107, 4.44664, 4.49407, 4.52964, 4.58893, 4.62451, 4.66008, 4.69565, 4.73123, 4.7668, 4.79051, 4.82609, 4.87352, 4.90909, 4.94466, 4.99209, 5.01581, 5.03953, 5.09881, 5.19368])*60
y_pwm100 = np.array([1091.61799, 1082.2722, 1071.05724, 1059.84229, 1048.62734, 1037.41238, 1026.19743, 1014.98248, 1005.63668, 994.42173, 983.20678, 971.99182, 960.77687, 949.56192, 938.34696, 927.13201, 915.91706, 904.7021, 893.48715, 880.40304, 869.18808, 859.84229, 848.62734, 837.41238, 826.19743, 814.98248, 803.76752, 796.29089, 786.94509, 775.73014, 764.51519, 753.30023, 742.08528, 730.87033, 719.65537, 708.44042, 697.22547, 684.14136, 672.9264, 663.58061, 652.36565, 641.1507, 629.93575, 618.72079, 607.50584, 598.16005, 583.20678, 573.86098, 566.38435, 557.03855, 551.43107, 543.95444, 532.71028, 525.26285, 515.91706, 508.44042, 497.22547, 487.87967, 476.66472, 467.31893, 457.97313, 446.75818, 435.54322, 424.32827, 413.11332, 401.89836, 392.55257, 381.33762, 368.2535, 347.69276, 336.4778, 325.26285, 314.0479, 302.83294, 291.61799, 280.40304, 269.18808, 257.97313, 246.75818, 235.54322, 224.32827, 209.375, 198.16005, 186.94509, 175.73014, 164.51519, 153.30023, 142.08528, 130.87033, 119.65537, 108.44042, 97.22547, 86.01051, 74.79556, 63.58061, 44.88902, 18.69159])

x_pwm50 = np.array([0.083, 0.11858, 0.16601, 0.21344, 0.26087, 0.35573, 0.3913, 0.43874, 0.47431, 0.50988, 0.54545, 0.59289, 0.65217, 0.6996, 0.73518, 0.78261, 0.81818, 0.86561, 0.90119, 0.93676, 1.00791, 1.09091, 1.13834, 1.17391, 1.20949, 1.25692, 1.29249, 1.31621, 1.35178, 1.38735, 1.42292, 1.4585, 1.49407, 1.52964, 1.56522, 1.58893, 1.63636, 1.67194, 1.70751, 1.74308, 1.77866, 1.81423, 1.8498, 1.88538, 1.93281, 1.98024, 2.00395, 2.06324, 2.13439, 2.22925, 2.3004, 2.37154, 2.44269, 2.51383, 2.58498, 2.64427, 2.71542, 2.76285, 2.83399, 2.89328, 2.94071, 3, 3.03557, 3.09486, 3.14229, 3.18972, 3.23715, 3.28458, 3.33202, 3.37945, 3.42688, 3.48617, 3.5336, 3.58103, 3.62846, 3.66403])*60
y_pwm50 = np.array([856.10397, 844.88902, 833.67407, 822.45911, 811.24416, 786.94509, 775.73014, 764.51519, 753.30023, 742.08528, 730.87033, 719.65537, 704.7021, 693.48715, 682.2722, 671.05724, 659.84229, 648.62734, 637.41238, 629.93575, 611.24416, 586.94509, 575.73014, 564.51519, 553.30023, 542.08528, 530.87033, 519.65537, 508.44042, 497.22547, 486.01051, 474.79556, 461.71145, 450.4965, 439.28154, 428.06659, 416.85164, 401.89836, 390.68341, 379.46846, 368.2535, 357.03855, 345.8236, 330.87033, 319.65537, 308.44042, 297.22547, 287.87967, 278.53388, 267.31893, 261.71145, 256.10397, 248.62734, 243.01986, 231.80491, 224.32827, 213.11332, 201.89836, 194.42173, 183.20678, 171.99182, 162.64603, 151.43107, 140.21612, 129.00117, 117.78621, 106.57126, 95.35631, 84.14136, 72.9264, 61.71145, 50.4965, 39.28154, 28.06659, 16.85164, 5.63668])

x_pwm0 = np.array([0, 0.04743, 0.11858, 0.18972, 0.26087, 0.35573, 0.42688, 0.49802, 0.56917, 0.64032, 0.71146, 0.78261, 0.85375, 0.9249, 0.99605, 1.04348, 1.11462, 1.18577, 1.25692, 1.32806, 1.39921, 1.47036, 1.50593])*60
y_pwm0 = np.array([162.64603, 155.16939, 147.69276, 138.34696, 130.87033, 121.52453, 114.0479, 106.57126, 97.22547, 87.87967, 78.53388, 69.18808, 63.58061, 61.71145, 61.71145, 57.97313, 54.23481, 48.62734, 41.1507, 31.80491, 24.32827, 14.98248, 5.63668])

# 데이터 정리
data_Q = {0: x_pwm0, 50: x_pwm50, 100: x_pwm100}
data_P = {0: y_pwm0, 50: y_pwm50, 100: y_pwm100}

# ------------------- 2. 보간 함수 -------------------
interp_Q2P = {
    d: interp1d(data_Q[d], data_P[d], kind='linear', fill_value='extrapolate')
    for d in [0, 50, 100]
}

# 유량 Q → 정압 ΔP
def interpolate_pressure(Q_vals, d):
    if d <= 50:
        w = d / 50
        return (1 - w) * interp_Q2P[0](Q_vals) + w * interp_Q2P[50](Q_vals)
    else:
        w = (d - 50) / 50
        return (1 - w) * interp_Q2P[50](Q_vals) + w * interp_Q2P[100](Q_vals)

# 정압 ΔP → 유량 Q
def interpolate_flow(P_target, d):
    Q_range = np.linspace(0, 5.5*60, 300)
    P_vals = interpolate_pressure(Q_range, d)
    return np.interp(P_target, P_vals[::-1], Q_range[::-1])

# ------------------- 3. Duty vs Flow Rate (정압 기준) -------------------
duty_fine = np.linspace(0, 100, 101)
pressure_lines = np.linspace(100, 1000, 10)
Q_by_pressure = {
    P: [interpolate_flow(P, d) for d in duty_fine]
    for P in pressure_lines
}
colors_pressure = cm.rainbow(np.linspace(0, 1, len(pressure_lines)))

plt.figure(figsize=(10, 6))
for P, c in zip(pressure_lines, colors_pressure):
    plt.plot(duty_fine, Q_by_pressure[P], label=f'$P_{{static}}$ = {int(P)} Pa', color=c)
plt.xlabel('Duty cycle [%]')
plt.ylabel('Flow rate Q [$m^3/h$]')
plt.title('Duty cycle vs Flow rate at constant static pressures')
plt.xlim(left=0, right=100)
plt.ylim(bottom=0)
plt.grid(True)
plt.legend(title='Static pressure [Pa]')
plt.tight_layout()
plt.show()

# ------------------- 4. Duty vs Static Pressure (유량 기준) -------------------
flow_lines = np.linspace(0.3, 5.0*60, 10)
P_by_flow = {
    Q: [interpolate_pressure(np.array([Q]), d)[0] for d in duty_fine]
    for Q in flow_lines
}
colors_flow = cm.rainbow(np.linspace(0, 1, len(flow_lines)))

plt.figure(figsize=(10, 6))
for Q, c in zip(flow_lines, colors_flow):
    plt.plot(duty_fine, P_by_flow[Q], label=f'Q = {Q:.2f} $m^3/h$', color=c)
plt.xlabel('Duty cycle [%]')
plt.ylabel('Static pressure $P_{{static}}$ [Pa]')
plt.title('Duty cycle vs Static Pressure at constant flow rates')
plt.xlim(left=0, right=100)
plt.ylim(bottom=0)
plt.grid(True)
plt.legend(title='Flow rate [$m^3/h$]')
plt.tight_layout()
plt.show()


# ------------------- 5. 정압 vs 유량 그래프 (duty별) -------------------
duty_steps = np.arange(0, 101, 5)
Q_range = np.linspace(0, 5.5*60, 300)
colors = cm.rainbow(np.linspace(0, 1, len(duty_steps)))

plt.figure(figsize=(8, 6))
for d, c in zip(duty_steps, colors):
    P_vals = interpolate_pressure(Q_range, d)
    plt.plot(Q_range, P_vals, label=f'{d}% duty', color=c)
plt.xlabel('Flow rate Q [$m^3/h$]')
plt.ylabel('Static pressure $P_{{static}}$ [Pa]')
plt.title('$P_{{static}}$ vs Q for each duty cycle')
plt.xlim(left=0, right=350)
plt.ylim(bottom=0, top=1200)
# plt.grid(True)
plt.minorticks_on()

plt.grid(which='major', linestyle='-', linewidth='0.5', color='black')
plt.grid(which='minor', linestyle='-', linewidth='0.2', color='gray')

plt.legend(title='Duty cycle')
plt.tight_layout()
plt.savefig('N2stack_Fan_P-Q_curve-AR.png', dpi=600)
plt.show()
